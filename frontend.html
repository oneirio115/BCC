<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js"
        integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js"
        integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG"
        crossorigin="anonymous"></script>
    <script src="./node_modules/web3/dist/web3.min.js">
    </script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-dark">
        <div class="container-fluid justify-content-md-start">
            <img src="images/cup.jpg" alt="Simply Easy Learning" width="180" height="70">
            <h1 style="font-size:60px ; color:rgb(255, 2, 171)">Raju Rajai Café</h1>
        </div>
    </nav>
    <div class="container-fluid p-3 bg-light text-black">
        <br>
        <h1 style="text-align:center;font-size:40px">Welcome to Raju Rajai Café</h1>
        <h4 style="text-align:center">--------------------------------------------------------------------</h4>
    </div>
    <div class="blog">
        <div class="container-fluid p-5 text-dark">
            <div class="row" style="text-align:center">
                <div class="col-md-12">
                    <div class="title">
                        <br>
                        <i><img src="images/Menubook.jpg" alt="#" width="250" height="250"/></i>
                        <h1>Menu</h1>
                        <br><br>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <center>
                        <div class="card" style="width: 18rem;">
                            <img src="images/Pep.png" class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">Pepsi</h5>
                                <p class="card-text">Pepsi เย็น ๆ</p>
                                <button class="btn btn-warning" id="btnFood1" name="Pepsi" value="Pepsi">0.0020 eth</button>
                            </div>
                        </div>
                    </center>
                </div>

                <div class="col">
                    <center>
                        <div class="card" style="width: 18rem;">
                            <img src="images/Milk.jpg" class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">Milk Frappe</h5>
                                <p class="card-text">นมปั่น หอม มันยังกับอยุ่ในผับ</p>
                                <button class="btn btn-warning" id="btnFood2" name="Milk Frappe" value="Milk Frappe">0.0023 eth</button>
                            </div>
                        </div>
                    </center>
                </div>

                <div class="col">
                    <center>
                        <div class="card" style="width: 18rem;">
                            <img src="images/Water.png" class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">Drinking Water</h5>
                                <p class="card-text">น้ำเปล่า น้ำไม่ได้ทำ</p>
                                <button class="btn btn-warning" id="btnFood3" name="Drinking Water" value="Drinking Water">0.0015 eth</button>
                            </div>
                        </div>
                    </center>
                </div>
            </div>

            <br><br>
            <div class="row">
                <div class="col">
                    <center>
                        <div class="card" style="width: 18rem;">
                            <img src="images/Prok.jpg" class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">Pork Stake</h5>
                                <p class="card-text"> สเต็กหมู ครับ</p>
                                <button class="btn btn-warning" id="btnDrink1" name="Pork Stake" value="Pork Stake">0.0060 eth</button>
                            </div>
                        </div>
                    </center>
                </div>

                <div class="col">
                    <center>
                        <div class="card" style="width: 18rem;">
                            <img src="images/oreo.jpg" class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">Oreo Cake</h5>
                                <p class="card-text">เค้กโอรีโอ้ อร่อย</p>
                                <button class="btn btn-warning" id="btnDrink2" name="Oreo Cake" value="Oreo Cake">0.0080 eth</button>
                            </div>
                        </div>
                    </center>
                </div>

                <div class="col">
                    <center>
                        <div class="card" style="width: 18rem;">
                            <img src="images/F.jpg" class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">French Fries</h5>
                                <p class="card-text">อร่อยครับ ลองดู</p>
                                <button class="btn btn-warning" id="btnDrink3" name="French Fries" value="French Fries">0.0045 eth</button>
                            </div>
                        </div>
                    </center>
                </div>
            </div>

        </div>
    </div>
    <br><br>
    <div class="container p-3 bg-black" style="background-color:#BFC9CA  ;">
        <div class="title">
            <br>
            <h1 style="font-size:40px ; color: rgb(255, 0, 0) ; text-align:center "> ORDER TABLE </h1>
            <br><br>
        </div>
        <center>
        <table class="center" id="TableOrder" border="0" width="65%">
            <tr>
                <td><label class="cafe">No</label></td>
                <td><label class="cafe">Time</label></td>
                <td><label class="cafe">Order</label></td>
                <td><label class="cafe">Owner</label></td>
            </tr>
        </table>
        </center>

        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js">
        </script>
        <script>
            function insertData(n,o) {
                var name = n;
                var address = o;
                var dt = new Date();
                document.getElementById("insertionPoint").innerHTML += "<tr><td>" + dt.toLocaleTimeString() + "</td><td>" + name + "</td><td>" + address + "</td><tr>";
            }
        </script>
        <script>
            if (typeof web3 !== 'undefined') {
                // this statement is executed if you are using 
                // MetaMask 
                async function enableAccounts() {            
                    await ethereum.enable()
                }        
                enableAccounts();  
            } else {
                // set the provider you want from Web3.providers
                web3 = new Web3(
                    new Web3.providers.HttpProvider(
                    "http://localhost:8545"));
            }
    
            let abi = [
	{
		"constant": true,
		"inputs": [
			{
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getName",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "name",
				"type": "string"
			}
		],
		"name": "GetOrder",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getOrderCount",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getTimestamp",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getAddress",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "from",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "text",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "datetime",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "hash",
				"type": "bytes32"
			}
		],
		"name": "OrderAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "from",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "text",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "reason",
				"type": "string"
			}
		],
		"name": "OrderError",
		"type": "event"
	}
];
            var contract = web3.eth.contract(abi);
            var myContract = contract.at(
                '0x40D300D90f9d0b818924bCfd08FdACAe87b1dBdE');       
    
            var completeEvent =             
                myContract.OrderAdded();
    
            var refreshtable = false;
    
            completeEvent.watch(function(error, result) {
                if (!error){
            //$("#result").html("Got it");               
            if (result.args.from == web3.eth.defaultAccount){
                       $("#result").html("Order >> " + result.args.text); 
                       if (refreshtable == true){
                            insertData(result.args.text,result.args.from);
                            refreshtable = false;
                        }
                   }               
                }
            });
    
            var errorEvent = 
                myContract.OrderError();
    
            errorEvent.watch(function(error, result) {
                if (!error){
                   if (result.args.from == 
                       web3.eth.defaultAccount){
                       $("#result").html(
                           "Error. <br/> Name: " + 
                           result.args.text + 
                           "<br/> Reason: " + result.args.reason); 
                   }               
                }
            });
    
    //LateCoffee 0.011 eth
            $("#btnFood1").click(function(){
                SendOrder(2000000000000000, "Pepsi")
            });
    
    //Thaitea 0.014 eth
            $("#btnFood2").click(function(){
                SendOrder(2300000000000000, "Milk Frappe")
            });
    
    //Greentea 0.015 eth
            $("#btnFood3").click(function(){
                SendOrder(1500000000000000, "Driking Water")
            });
    
    //Friedrice 0.025 eth
            $("#btnDrink1").click(function(){
                SendOrder(6000000000000000, "Pork Stake")
            });
    
    //Steak 0.03 eth
            $("#btnDrink2").click(function(){
                SendOrder(8000000000000000, "Oreo Cake")
            });
    
    //Noodle 0.028 eth
            $("#btnDrink3").click(function(){
                SendOrder(4500000000000000, "French Fries")
            });
    
            async function GetvalueOrder(){
     
                var timestamp;
                var ordername;
                var owner;
                var i = 0;
    
                await ResetTable();
                myContract.getOrderCount((error, result) => {
                    if(!error){
                        setTimeout(function() {
                            selectOrder(parseInt(result.toString()));
                        }, 500);
                    }
                    else
                        console.error(error);
                });
                
                function selectOrder(index){
                    if(index > 0){
                        myContract.getTimestamp(i, (error, result) => {
                            if(!error){
                                timestamp = ConvertTimestamp(result);
                                myContract.getName(i, (error, result) => {
                                    if(!error){
                                        ordername = result.toString();
                                        myContract.getAddress(i, (error, result) => {
                                            if(!error){
                                                owner = result.toString();
                                                if(i < index){
                                                    listOrder(timestamp, ordername, owner);
                                                    i++;
                                                    selectOrder(index);
                                                }
                                            }
                                            else
                                                console.error(error);
                                        });
                                    }
                                    else
                                        console.error(error);
                                });
                            }
                            else
                                console.error(error);
                        });
                    }
                }
    
            }
    
            function SendOrder(value, ordername){
                refreshtable = true;
                myContract.GetOrder(ordername,
                {
                    gas: 300000,
                    from: web3.eth.accounts[0],
                    value: value
                },(error, result) => {
                    $("#result").html("Order pending confirmation.....");
                });
            }
    
            function listOrder(timestamp, ordername, owner, i){
                var queueOrder = document.getElementById("TableOrder");
    
                var r_count = queueOrder.rows.length;
                console.log("r_count");
                console.log(r_count);
                var row = queueOrder.insertRow(r_count);
    
                row.insertCell(0).innerHTML = r_count;
                row.insertCell(1).innerHTML = timestamp;
                row.insertCell(2).innerHTML = ordername;
                row.insertCell(3).innerHTML = owner;
            }
    
            function ResetTable(){
                var queueOrder = document.getElementById("TableOrder");
    
                while(queueOrder.rows.length > 1){
                    queueOrder.deleteRow(queueOrder.rows.length - 1);
                }
            }
    
            function ConvertTimestamp(timestamp){
                var mon = ["January", 
                           "February",
                           "March", 
                           "April", 
                           "May", 
                           "June", 
                           "July", 
                           "August", 
                           "September", 
                           "October", 
                           "November", 
                           "December"];
    
                var timeconvert = new Date(timestamp * 1000)
    
                return (timeconvert.getDate().toString() + " " +
                    mon[timeconvert.getMonth() + 1] + " " +
                    timeconvert.getFullYear().toString() + "   " +
                    (timeconvert.getHours() % 10 == timeconvert.getHours() ? "0" + 
                    timeconvert.getHours().toString() : timeconvert.getHours().toString()) + ":" +
                    (timeconvert.getMinutes() % 10 == timeconvert.getMinutes() ? "0" + 
                    timeconvert.getMinutes().toString() : timeconvert.getMinutes().toString())
                )
            }
    
            window.onload = GetvalueOrder();
        
        </script>

    </div>

</body>

</html>